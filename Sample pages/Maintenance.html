<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Maintenance / Multi-Service Estimator</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #007bff;
    }
    
    h1, h2, h3 {
      color: #2c3e50;
      margin-top: 0;
    }
    
    h1 {
      font-size: 28px;
      background: linear-gradient(90deg, #007bff, #00c6ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }
    
    .subtitle {
      color: #7f8c8d;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }
    
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border-left: 5px solid #007bff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .section {
      margin-bottom: 25px;
    }
    
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .edit-btn {
      background: #28a745;
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .edit-btn:hover {
      background: #218838;
    }
    
    .edit-mode {
      background: #fff3cd;
      border-left-color: #ffc107;
    }
    
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      transition: all 0.2s ease;
    }
    
    .checkbox-item:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #007bff;
    }
    
    .optional-text {
      color: #6c757d;
      font-size: 14px;
      font-style: italic;
      margin-left: 5px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    th, td {
      border: 1px solid #dee2e6;
      padding: 12px 10px;
      text-align: center;
    }
    
    th {
      background: #007bff;
      color: white;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    input[type=range] {
      width: 100px;
      accent-color: #007bff;
    }
    
    input[type=number], select {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
    }
    
    input[type=number]:focus, select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }
    
    .currency-section {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .currency-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }
    
    .currency-box {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #b8daff;
    }
    
    .currency-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #0056b3;
    }
    
    .currency-value {
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
      margin-top: 10px;
    }
    
    .total-box {
      background: linear-gradient(135deg, #007bff 0%, #00c6ff 100%);
      color: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 30px;
      box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2);
    }
    
    .total-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .total-header h3 {
      color: white;
      margin: 0;
    }
    
    .invoice {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      padding: 20px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      margin: 0;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
    }
    
    .alert-box {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      border-left: 5px solid #dc3545;
      margin-top: 10px;
      display: none;
    }
    
    .success-msg {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 6px;
      border-left: 5px solid #28a745;
      margin-top: 10px;
      display: none;
    }
    
    .small-note {
      font-size: 14px;
      color: #6c757d;
      margin-top: 5px;
      line-height: 1.5;
    }
    
    .badge {
      display: inline-block;
      background: #007bff;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 5px;
    }
    
    .highlight {
      background: #fff3cd;
      padding: 2px 5px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Enhanced Maintenance / Multi-Service Estimator</h1>
        <div class="subtitle">Complete cleaning service estimation with currency conversion</div>
      </div>
      <div class="buttons">
        <button onclick="location.href='./estimation.html'">
          <span>üîó</span> Open Steam Estimator
        </button>
        <button onclick="resetAll()">
          <span>üîÑ</span> Reset All
        </button>
      </div>
    </header>

    <div class="main-grid">
      <!-- Left Column: Service Selection & Options -->
      <div>
        <!-- Currency Settings -->
        <div class="currency-section">
          <h3>Currency Settings</h3>
          <div class="currency-grid">
            <div class="currency-box">
              <label class="currency-label">USD to CAD Rate</label>
              <input type="number" id="usdToCadRate" min="1.0" max="2.0" step="0.01" value="1.36" oninput="calculateEstimate()">
              <div class="small-note">Current: 1 USD = <span id="currentCadRate">1.36</span> CAD</div>
            </div>
            <div class="currency-box">
              <label class="currency-label">CAD to USD Rate</label>
              <input type="number" id="cadToUsdRate" min="0.5" max="1.0" step="0.01" value="0.74" oninput="calculateEstimate()">
              <div class="small-note">Current: 1 CAD = <span id="currentUsdRate">0.74</span> USD</div>
            </div>
          </div>
        </div>

        <!-- Service Options -->
        <div class="card">
          <div class="section-title">
            <h3>Service Selection</h3>
          </div>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="serviceMaintenance" onchange="toggleMaintenanceOptions()">
              <label for="serviceMaintenance"><strong>Maintenance Clean</strong></label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="serviceMoveout" onchange="toggleMoveoutOptions()">
              <label for="serviceMoveout"><strong>Move Out Clean</strong></label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="serviceDeep" onchange="toggleDeepOptions()">
              <label for="serviceDeep"><strong>Deep Clean</strong></label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="serviceSteam" onchange="calculateEstimate()">
              <label for="serviceSteam"><strong>Include Steam Clean</strong> <span class="badge">From Estimator</span></label>
            </div>
          </div>
          <div class="small-note">
            <strong>Tip:</strong> Open the Steam Estimator, calculate & save there first ‚Äî then check "Include Steam Clean" to pull the exact Steam invoice/total.
          </div>
        </div>

        <!-- Travel Time -->
        <div class="card">
          <h3>Travel Time Fee Estimation</h3>
          <div class="section">
            <label><strong>Rate Type:</strong></label>
            <select id="travelType" onchange="calculateEstimate()">
              <option value="residential" selected>Residential ($38/hr)</option>
              <option value="commercial">Commercial ($44/hr)</option>
            </select>
          </div>
          
          <div class="section">
            <label><strong>Travel Time (minutes):</strong></label>
            <input type="number" id="travelMinutes" placeholder="e.g. 45" min="0" max="120" step="5" oninput="calculateEstimate()">
          </div>
          
          <div>
            <strong>Travel Fee:</strong> $<span id="travelCostDisplay">0.00</span>
          </div>
        </div>
      </div>

      <!-- Right Column: Service Details -->
      <div>
        <!-- Maintenance Options -->
        <div id="maintenanceOptions" class="card" style="display:none;">
          <div class="section-title">
            <h3>Maintenance Clean Options</h3>
            <button class="edit-btn" id="editMaintenanceBtn" onclick="toggleEditMode('maintenance')">
              <span>‚úèÔ∏è</span> Edit Fields
            </button>
          </div>
          
          <p id="residentialNote" class="small-note" style="display:none; color: #dc3545; font-weight: bold;">
            Minimum booking for maintenance is <span class="highlight">3 hours</span>.
          </p>

          <div class="section">
            <label><input type="radio" name="rateType" value="residential" onchange="toggleRateType()" checked> Residential ($38/hr)</label>
            <label style="margin-left: 20px;"><input type="radio" name="rateType" value="commercial" onchange="toggleRateType()"> Commercial ($44/hr)</label>
          </div>

          <!-- Visit Estimation (Commercial only) -->
          <div id="visitOption" style="display:none; margin-top:15px;">
            <label><input type="checkbox" id="visitEstimation" onchange="toggleVisitEstimation()"> Visit Estimation Required</label>
            <div id="visitAlert" class="alert-box">‚ö† Invoice is paused until visit estimation is processed.</div>
            <div id="visitSuccess" class="success-msg">‚úÖ Visit estimation finalized. You can now proceed to booking.</div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Room</th>
                <th>Base Hours</th>
                <th>Large?</th>
                <th>Extra Hours</th>
                <th>Total Hours</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Kitchen</td>
                <td><input type="number" id="kitchenBase" class="editable-field" value="3" min="0" step="0.5" disabled onchange="calculateEstimate()"></td>
                <td><input type="checkbox" id="kitchenLarge" onchange="calculateEstimate()"> +<span id="kitchenLargeAdd">1.5</span> hrs</td>
                <td>
                  <input type="range" id="kitchenExtra" min="0" max="5" step="0.25" value="0" oninput="updateExtraDisplay('kitchen')">
                  <div class="small-note"><span id="kitchenExtraDisplay">0.00</span> hrs</div>
                </td>
                <td id="kitchenHours">3.00</td>
              </tr>
              <tr>
                <td>Bedroom</td>
                <td><input type="number" id="bedroomBase" class="editable-field" value="1" min="0" step="0.5" disabled onchange="calculateEstimate()"></td>
                <td><input type="checkbox" id="bedroomLarge" onchange="calculateEstimate()"> +<span id="bedroomLargeAdd">0.5</span> hrs</td>
                <td>
                  <input type="range" id="bedroomExtra" min="0" max="5" step="0.25" value="0" oninput="updateExtraDisplay('bedroom')">
                  <div class="small-note"><span id="bedroomExtraDisplay">0.00</span> hrs</div>
                </td>
                <td id="bedroomHours">1.00</td>
              </tr>
              <tr>
                <td>Bathroom</td>
                <td><input type="number" id="bathroomBase" class="editable-field" value="2.5" min="0" step="0.5" disabled onchange="calculateEstimate()"></td>
                <td><input type="checkbox" id="bathroomLarge" onchange="calculateEstimate()"> +<span id="bathroomLargeAdd">1.0</span> hrs</td>
                <td>
                  <input type="range" id="bathroomExtra" min="0" max="5" step="0.25" value="0" oninput="updateExtraDisplay('bathroom')">
                  <div class="small-note"><span id="bathroomExtraDisplay">0.00</span> hrs</div>
                </td>
                <td id="bathroomHours">2.50</td>
              </tr>
              <tr>
                <td>Entryway</td>
                <td><input type="number" id="entryBase" class="editable-field" value="0.5" min="0" step="0.5" disabled onchange="calculateEstimate()"></td>
                <td><input type="checkbox" disabled> (fixed)</td>
                <td>
                  <input type="range" id="entryExtra" min="0" max="3" step="0.25" value="0" oninput="updateExtraDisplay('entry')">
                  <div class="small-note"><span id="entryExtraDisplay">0.00</span> hrs</div>
                </td>
                <td id="entryHours">0.50</td>
              </tr>
            </tbody>
          </table>
          <div class="small-note" id="editNote" style="display:none; color: #856404; background: #fff3cd; padding: 8px; border-radius: 4px;">
            <strong>Edit Mode Active:</strong> You can now edit the base hours for each room. Click "Save Changes" when done.
          </div>
        </div>

        <!-- Move Out Options -->
        <div id="moveoutOptions" class="card" style="display:none;">
          <h3>Move Out Smart Estimator</h3>
          <p>Automatically estimates hours based on size and hourly rate.</p>
          
          <div class="section">
            <label><strong>Home Size:</strong></label>
            <select id="moveoutSize" onchange="calculateEstimate()">
              <option value="small" selected>Small ‚Äî 7‚Äì8 hrs</option>
              <option value="medium">Medium ‚Äî 9‚Äì15 hrs</option>
              <option value="large">Large ‚Äî 15+ hrs</option>
            </select>
          </div>
          
          <div class="section">
            <label><strong>Approximate Square Footage <span class="optional-text">(optional)</span>:</strong></label>
            <input type="number" id="moveoutSqft" placeholder="e.g. 1800" min="300" step="50" oninput="calculateEstimate()">
          </div>
          
          <div class="section">
            <label><strong>Hourly Rate ($):</strong></label>
            <input type="number" id="moveoutRate" placeholder="e.g. 50" min="20" step="1" value="50" oninput="calculateEstimate()">
          </div>
          
          <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 6px;">
            <strong>Estimated Hours:</strong> <span id="moveoutHoursDisplay">0.00</span><br>
            <strong>Estimated Cost:</strong> $<span id="moveoutCostDisplay">0.00</span>
          </div>
        </div>

        <!-- Deep Clean Options -->
        <div id="deepOptions" class="card" style="display:none;">
          <h3>Deep Clean Smart Estimator</h3>
          <p>Estimate dynamically based on home size (no fixed rate).</p>
          
          <div class="section">
            <label><strong>Home Size:</strong></label>
            <select id="deepSize" onchange="calculateEstimate()">
              <option value="small" selected>Small ‚Äî minimum 7‚Äì8 hrs</option>
              <option value="medium">Medium ‚Äî 9‚Äì15 hrs</option>
              <option value="large">Large ‚Äî 15+ hrs</option>
            </select>
          </div>
          
          <div class="section">
            <label><strong>Approximate Square Footage <span class="optional-text">(optional)</span>:</strong></label>
            <input type="number" id="deepSqft" placeholder="e.g. 1500" min="300" step="50" oninput="calculateEstimate()">
          </div>
          
          <div class="section">
            <label><strong>Hourly Rate ($):</strong></label>
            <input type="number" id="deepRate" placeholder="e.g. 50" min="20" step="1" value="50" oninput="calculateEstimate()">
          </div>
          
          <p class="small-note">Minimum 7 hours for small homes. Larger spaces may increase hours automatically.</p>
          
          <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 6px;">
            <strong>Estimated Hours:</strong> <span id="deepHoursDisplay">0.00</span><br>
            <strong>Estimated Cost:</strong> $<span id="deepCostDisplay">0.00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Final Estimate -->
    <div class="total-box">
      <div class="total-header">
        <h3>Final Estimate Invoice</h3>
        <div style="text-align: right;">
          <div class="currency-value">
            USD: $<span id="totalUsd">0.00</span> | 
            CAD: $<span id="totalCad">0.00</span>
          </div>
        </div>
      </div>
      
      <pre id="finalInvoice" class="invoice"></pre>
      
      <div style="display: flex; gap: 15px; margin-top: 20px;">
        <button id="finalizeVisitBtn" style="display:none; background: #28a745;" onclick="finalizeVisitEstimation()">
          <span>‚úÖ</span> Finalize Visit Estimation
        </button>
        <button id="bookButton" disabled>
          <span>üìÖ</span> Book Service
        </button>
        <button onclick="printInvoice()" style="background: #6c757d;">
          <span>üñ®Ô∏è</span> Print Invoice
        </button>
      </div>
    </div>
  </div>

  <script>
    // Global state for edit mode
    let editMode = {
      maintenance: false,
      moveout: false,
      deep: false
    };

    // Toggle visibility of service options
    function toggleMaintenanceOptions() {
      const isChecked = document.getElementById("serviceMaintenance").checked;
      document.getElementById("maintenanceOptions").style.display = isChecked ? "block" : "none";
      calculateEstimate();
    }

    function toggleMoveoutOptions() {
      const isChecked = document.getElementById("serviceMoveout").checked;
      document.getElementById("moveoutOptions").style.display = isChecked ? "block" : "none";
      calculateEstimate();
    }

    function toggleDeepOptions() {
      const isChecked = document.getElementById("serviceDeep").checked;
      document.getElementById("deepOptions").style.display = isChecked ? "block" : "none";
      calculateEstimate();
    }

    // Toggle edit mode for maintenance fields
    function toggleEditMode(section) {
      editMode[section] = !editMode[section];
      const editableFields = document.querySelectorAll(`#${section}Options .editable-field`);
      const editNote = document.getElementById('editNote');
      const editBtn = document.getElementById(`edit${section.charAt(0).toUpperCase() + section.slice(1)}Btn`);
      
      editableFields.forEach(field => {
        field.disabled = !editMode[section];
      });
      
      if (section === 'maintenance') {
        const card = document.getElementById('maintenanceOptions');
        if (editMode[section]) {
          card.classList.add('edit-mode');
          editNote.style.display = 'block';
          editBtn.innerHTML = '<span>üíæ</span> Save Changes';
        } else {
          card.classList.remove('edit-mode');
          editNote.style.display = 'none';
          editBtn.innerHTML = '<span>‚úèÔ∏è</span> Edit Fields';
          calculateEstimate(); // Recalculate after saving
        }
      }
    }

    // Update extra hours display
    function updateExtraDisplay(room) {
      const extraSlider = document.getElementById(`${room}Extra`);
      const extraDisplay = document.getElementById(`${room}ExtraDisplay`);
      extraDisplay.textContent = parseFloat(extraSlider.value).toFixed(2);
      calculateEstimate();
    }

    // Toggle rate type and show/hide visit option
    function toggleRateType() {
      const rateType = document.querySelector('input[name="rateType"]:checked').value;
      const visitOption = document.getElementById("visitOption");
      const residentialNote = document.getElementById("residentialNote");
      
      if (rateType === "commercial") {
        visitOption.style.display = "block";
        residentialNote.style.display = "none";
      } else {
        visitOption.style.display = "none";
        residentialNote.style.display = "block";
        document.getElementById("visitEstimation").checked = false;
        toggleVisitEstimation(false);
      }
      calculateEstimate();
    }

    // Handle visit estimation
    function toggleVisitEstimation() {
      const isVisit = document.getElementById("visitEstimation").checked;
      const alertBox = document.getElementById("visitAlert");
      const successBox = document.getElementById("visitSuccess");
      const bookBtn = document.getElementById("bookButton");
      const finalizeBtn = document.getElementById("finalizeVisitBtn");

      if (isVisit) {
        alertBox.style.display = "block";
        successBox.style.display = "none";
        finalizeBtn.style.display = "inline-block";
        bookBtn.disabled = true;
      } else {
        alertBox.style.display = "none";
        successBox.style.display = "none";
        finalizeBtn.style.display = "none";
        bookBtn.disabled = false;
      }
      calculateEstimate();
    }

    // Finalize visit estimation
    function finalizeVisitEstimation() {
      document.getElementById("visitAlert").style.display = "none";
      document.getElementById("visitSuccess").style.display = "block";
      document.getElementById("bookButton").disabled = false;
      document.getElementById("finalizeVisitBtn").style.display = "none";
      alert("Visit estimation finalized. You can now proceed to booking.");
    }

    // Main calculation function
    function calculateEstimate() {
      const breakdown = [];
      let subtotal = 0;
      
      // Get currency rates
      const usdToCadRate = parseFloat(document.getElementById("usdToCadRate").value) || 1.36;
      const cadToUsdRate = parseFloat(document.getElementById("cadToUsdRate").value) || 0.74;
      
      // Update displayed rates
      document.getElementById("currentCadRate").textContent = usdToCadRate.toFixed(2);
      document.getElementById("currentUsdRate").textContent = cadToUsdRate.toFixed(2);

      // Maintenance calculation
      if (document.getElementById("serviceMaintenance").checked) {
        const rateType = document.querySelector('input[name="rateType"]:checked').value;
        const rate = (rateType === "residential") ? 38 : 44;
        
        // Get editable base values
        const kitchenBase = parseFloat(document.getElementById("kitchenBase").value) || 3;
        const bedroomBase = parseFloat(document.getElementById("bedroomBase").value) || 1;
        const bathroomBase = parseFloat(document.getElementById("bathroomBase").value) || 2.5;
        const entryBase = parseFloat(document.getElementById("entryBase").value) || 0.5;
        
        // Calculate each room
        const kitchenLargeAdd = document.getElementById("kitchenLarge").checked ? 1.5 : 0;
        const kitchenExtra = parseFloat(document.getElementById("kitchenExtra").value) || 0;
        const kitchen = round2(kitchenBase + kitchenLargeAdd + kitchenExtra);
        document.getElementById("kitchenHours").textContent = kitchen.toFixed(2);
        
        const bedroomLargeAdd = document.getElementById("bedroomLarge").checked ? 0.5 : 0;
        const bedroomExtra = parseFloat(document.getElementById("bedroomExtra").value) || 0;
        const bedroom = round2(bedroomBase + bedroomLargeAdd + bedroomExtra);
        document.getElementById("bedroomHours").textContent = bedroom.toFixed(2);
        
        const bathroomLargeAdd = document.getElementById("bathroomLarge").checked ? 1 : 0;
        const bathroomExtra = parseFloat(document.getElementById("bathroomExtra").value) || 0;
        const bathroom = round2(bathroomBase + bathroomLargeAdd + bathroomExtra);
        document.getElementById("bathroomHours").textContent = bathroom.toFixed(2);
        
        const entryExtra = parseFloat(document.getElementById("entryExtra").value) || 0;
        const entryway = round2(entryBase + entryExtra);
        document.getElementById("entryHours").textContent = entryway.toFixed(2);
        
        // Total hours with minimum enforcement
        let totalHours = kitchen + bedroom + bathroom + entryway;
        const minHours = (rateType === "residential") ? 3 : 6;
        const totalHoursApplied = (totalHours < minHours) ? minHours : totalHours;
        
        const maintenanceCost = round2(totalHoursApplied * rate);
        subtotal += maintenanceCost;
        breakdown.push(`Maintenance Clean (${rateType}, ${totalHoursApplied.toFixed(2)} hrs @ $${rate}/hr) ........ $${maintenanceCost.toFixed(2)}`);
      }

      // Steam Clean calculation
      if (document.getElementById("serviceSteam").checked) {
        const steamInvoice = localStorage.getItem("steamInvoice");
        const steamTotal = parseFloat(localStorage.getItem("steamTotal") || "0");
        
        if (steamInvoice && steamTotal > 0) {
          subtotal += steamTotal;
          breakdown.push("---- Included Steam Clean Invoice ----");
          breakdown.push(steamInvoice.split('\n')[0]); // Just show first line
          breakdown.push(`Steam Clean Total .......................... $${steamTotal.toFixed(2)}`);
        } else {
          const fallbackSteam = 120;
          subtotal += fallbackSteam;
          breakdown.push(`Steam Clean (basic package) ................ $${fallbackSteam.toFixed(2)}`);
        }
      }

      // Move Out calculation
      if (document.getElementById("serviceMoveout").checked) {
        const size = document.getElementById("moveoutSize").value;
        const sqft = parseFloat(document.getElementById("moveoutSqft").value) || 0;
        const rate = parseFloat(document.getElementById("moveoutRate").value) || 0;
        
        let baseHours = (size === "small") ? 7 : (size === "medium") ? 10 : 15;
        
        // Only use square footage if provided
        let estimatedHours = baseHours;
        if (sqft > 0) {
          const sqftFactor = (size === "small") ? sqft / 300 : 
                            (size === "medium") ? sqft / 250 : sqft / 200;
          estimatedHours = Math.max(baseHours, sqftFactor);
        }
        
        const totalCost = round2(estimatedHours * rate);
        document.getElementById("moveoutHoursDisplay").textContent = estimatedHours.toFixed(2);
        document.getElementById("moveoutCostDisplay").textContent = totalCost.toFixed(2);
        
        if (rate > 0) {
          subtotal += totalCost;
          const sqftText = sqft > 0 ? `, ${sqft.toFixed(0)} sqft` : '';
          breakdown.push(`Move Out Clean (${size}${sqftText}) ‚Äî ${estimatedHours.toFixed(2)} hrs @ $${rate}/hr ... $${totalCost.toFixed(2)}`);
        }
      }

      // Deep Clean calculation
      if (document.getElementById("serviceDeep").checked) {
        const size = document.getElementById("deepSize").value;
        const sqft = parseFloat(document.getElementById("deepSqft").value) || 0;
        const rate = parseFloat(document.getElementById("deepRate").value) || 0;
        
        let baseHours = (size === "small") ? 7 : (size === "medium") ? 10 : 15;
        
        // Only use square footage if provided
        let estimatedHours = baseHours;
        if (sqft > 0) {
          const sqftFactor = (size === "small") ? sqft / 300 : 
                            (size === "medium") ? sqft / 250 : sqft / 200;
          estimatedHours = Math.max(baseHours, sqftFactor);
        }
        
        const totalCost = round2(estimatedHours * rate);
        document.getElementById("deepHoursDisplay").textContent = estimatedHours.toFixed(2);
        document.getElementById("deepCostDisplay").textContent = totalCost.toFixed(2);
        
        if (rate > 0) {
          subtotal += totalCost;
          const sqftText = sqft > 0 ? `, ${sqft.toFixed(0)} sqft` : '';
          breakdown.push(`Deep Clean (${size}${sqftText}) ‚Äî ${estimatedHours.toFixed(2)} hrs @ $${rate}/hr ........ $${totalCost.toFixed(2)}`);
        }
      }

      // Travel Time calculation
      const travelType = document.getElementById("travelType").value;
      const travelMinutes = parseFloat(document.getElementById("travelMinutes").value) || 0;
      const travelRate = (travelType === "residential") ? 38 : 44;
      
      if (travelMinutes > 0) {
        const travelHours = travelMinutes / 60;
        const travelCost = round2(travelHours * travelRate);
        document.getElementById("travelCostDisplay").textContent = travelCost.toFixed(2);
        subtotal += travelCost;
        breakdown.push(`Travel Time Fee (${travelType}) ‚Äî ${travelMinutes} mins @ $${travelRate}/hr ... $${travelCost.toFixed(2)}`);
      } else {
        document.getElementById("travelCostDisplay").textContent = "0.00";
      }

      // Tax and totals
      const tax = round2(subtotal * 0.05);
      const total = round2(subtotal + tax);
      const totalCad = round2(total * usdToCadRate);
      const totalUsd = round2(total * cadToUsdRate);

      // Build invoice
      let invoiceText = `ENHANCED CLEANING ESTIMATE\n`;
      invoiceText += `========================================\n`;
      invoiceText += breakdown.join('\n');
      invoiceText += `\n========================================\n`;
      invoiceText += `Subtotal: ................................ $${subtotal.toFixed(2)}\n`;
      invoiceText += `Tax (5%): ................................ $${tax.toFixed(2)}\n`;
      invoiceText += `----------------------------------------\n`;
      invoiceText += `TOTAL DUE (USD): ......................... $${total.toFixed(2)}\n`;
      invoiceText += `TOTAL DUE (CAD): ......................... $${totalCad.toFixed(2)}\n`;
      invoiceText += `========================================\n`;
      invoiceText += `Exchange Rates:\n`;
      invoiceText += `  1 USD = ${usdToCadRate.toFixed(2)} CAD\n`;
      invoiceText += `  1 CAD = ${cadToUsdRate.toFixed(2)} USD\n`;
      invoiceText += `========================================`;

      document.getElementById("finalInvoice").textContent = invoiceText;
      document.getElementById("totalUsd").textContent = total.toFixed(2);
      document.getElementById("totalCad").textContent = totalCad.toFixed(2);
    }

    // Utility functions
    function round2(n) { return Math.round(n * 100) / 100; }
    
    function resetAll() {
      if (confirm("Are you sure you want to reset all fields?")) {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[type="number"]').forEach(input => {
          if (input.id.includes('Rate') && !input.id.includes('moveout') && !input.id.includes('deep')) {
            // Keep currency rates
            if (input.id === 'usdToCadRate') input.value = 1.36;
            if (input.id === 'cadToUsdRate') input.value = 0.74;
          } else if (input.id.includes('Base')) {
            // Keep base values
          } else {
            input.value = input.min || 0;
          }
        });
        document.querySelectorAll('input[type="range"]').forEach(range => range.value = 0);
        document.querySelectorAll('.extra-display').forEach(span => span.textContent = '0.00');
        document.getElementById("visitEstimation").checked = false;
        document.querySelector('input[name="rateType"][value="residential"]').checked = true;
        
        // Hide all options
        document.getElementById("maintenanceOptions").style.display = "none";
        document.getElementById("moveoutOptions").style.display = "none";
        document.getElementById("deepOptions").style.display = "none";
        document.getElementById("visitOption").style.display = "none";
        
        calculateEstimate();
      }
    }
    
    function printInvoice() {
      const invoiceText = document.getElementById("finalInvoice").textContent;
      const printWindow = window.open('', '', 'width=800,height=600');
      printWindow.document.write(`
        <html>
          <head>
            <title>Invoice</title>
            <style>
              body { font-family: monospace; padding: 20px; }
              pre { white-space: pre-wrap; font-size: 14px; }
              @media print {
                body { margin: 0; }
              }
            </style>
          </head>
          <body>
            <pre>${invoiceText}</pre>
            <script>
              window.onload = function() { window.print(); } 
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      calculateEstimate();
      
      // Set up event listeners
      document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', calculateEstimate);
        if (el.type === 'range' || el.type === 'number') {
          el.addEventListener('input', calculateEstimate);
        }
      });
      
      // Initialize extra displays
      ['kitchen', 'bedroom', 'bathroom', 'entry'].forEach(room => {
        updateExtraDisplay(room);
      });
    });
  </script>
</body>
</html>